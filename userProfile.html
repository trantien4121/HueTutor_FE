<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="fonts/icomoon/style.css">

    <link rel="stylesheet" href="css/owl.carousel.min.css">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Boostrap icon -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css">

    <link rel="stylesheet" href="css/searchbar.css">

    <link rel="stylesheet" href="css/userProfile.css">

    <!--Lấy plugin của fanpage-->
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous"
        src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v16.0&appId=2014861808848576&autoLogAppEvents=1"
        nonce="CHBrokX5"></script>

    <title>Hue Tutors</title>
</head>

<body>

    <!--Mobile menu responsive-->
    <div class="site-mobile-menu site-navbar-target">
        <div class="site-mobile-menu-header">
            <div class="site-mobile-menu-close mt-3">
                <span class="icon-close2 js-menu-toggle"></span>
            </div>
        </div>
        <div class="site-mobile-menu-body"></div>
    </div>

    <!--Top Bar-->
    <div class="top-bar">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <a href="#" class=""><span class="mr-1  icon-envelope-open-o"
                            style="color: rgb(218, 125, 125); font-size: 16px;"></span> <span
                            class="d-none d-md-inline-block">Huetutors@gmail.com</span></a>
                    <span class="mx-md-2 d-inline-block"></span>
                    <a href="#" class=""><span class="mr-1  icon-phone"
                            style="color: rgb(24, 165, 24); font-size: 16px;"></span>
                        <span class="d-none d-md-inline-block">
                            (+84) 345476075
                        </span></a>


                    <div class="float-right">

                        <a href="#" class=""><span class="mr-1  icon-twitter"
                                style="color: #1DA1F2; font-size: 16px;"></span> <span
                                class="d-none d-md-inline-block">Twitter</span></a>
                        <span class="mx-md-2 d-inline-block"></span>
                        <a href="#" class=""><span class="mr-1  icon-facebook-official"
                                style="color: #3B5998; font-size: 16px;"></span> <span
                                class="d-none d-md-inline-block">Facebook</span></a>

                    </div>

                </div>

            </div>

        </div>
    </div>

    <!--Navbar_header-->
    <header class="site-navbar js-sticky-header site-navbar-target" role="banner">

        <div class="container">
            <div class="row align-items-center position-relative">


                <div class="site-logo">
                    <a href="index.html" class="text-black">
                        <img srcset="../images/Logo.png 11x" alt="" class="logo">
                    </a>
                </div>

                <div class="col-12">
                    <nav class="site-navigation text-right ml-auto " role="navigation">

                        <ul class="site-menu main-menu js-clone-nav ml-auto d-none d-lg-block">
                            <li class="menu-active"><a href="index.html" class="nav-link"><i
                                        class="mr-1 bi bi-house-door"></i>Trang chủ</a></li>
                            <li><a href="tutor.html" class="nav-link"><i class="mr-1 bi bi-mortarboard"></i>Gia
                                    sư</a></li>


                            <li class="has-children">
                                <a href="#about-section" class="nav-link">Thông tin</a>
                                <ul class="dropdown arrow-top">
                                    <li><a href="#info-section" class="nav-link">Quy trình dạy và học</a></li>
                                    <li><a href="#pricing-section" class="nav-link">Lớp mới</a></li>
                                    <li><a href="#tui-section" class="nav-link">Học phí tham khảo</a></li>
                                </ul>
                            </li>

                            <li><a href="blog.html" class="nav-link"><i class="mr-1 bi bi-person-vcard"></i>Bài
                                    viết</a></li>
                            <li><a href="register.html" class="nav-link register-block"><i
                                        class="mr-1 bi bi-person-add"></i>Đăng ký</a></li>
                            <li><a href="login.html" class="nav-link login-block"><i class="mr-1 bi bi-person"></i>Đăng
                                    nhập</a></li>
                        </ul>
                    </nav>

                </div>

                <div class="toggle-button d-inline-block d-lg-none"><a href="#"
                        class="site-menu-toggle py-5 js-menu-toggle text-black"><span class="icon-menu h3"></span></a>
                </div>

            </div>
        </div>

    </header>

    <main>
        <div class="tuition-fee-info-section pb-5">
            <form id="update-form">
                <div class="container">
                    <div class="row gutters">
                        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="account-settings">
                                        <div class="user-profile">
                                            <div class="user-avatar">
                                                <img id="avatar" src="images/ilu_empty_user.png" alt="Maxwell Admin">
                                            </div>
                                            <label for="file" class="custom-file-upload">
                                                <i class="bi bi-pencil-square"></i>
                                            </label>
                                            <input id="file" type="file" class="form-control" name="file" />

                                            <h5 class="user-name">Đoàn Quang Thái</h5>
                                            <h6 class="user-email mt-3">qthai@gmail.com</h6>
                                            <h6 class="like-tutor mt-3">Like numbers: 0</h6>
                                        </div>
                                        <!-- <div class="about">
                                        <h5>About</h5>
                                        <p>Address: Phú Thượng, TP Huế</p>
                                        <p>Phone number: 05845348543</p>
                                        <p>Like numbers: 5</p>
                                    </div> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="row gutters">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 mb-3">
                                            <h6 class="mb-2 text-primary">Personal info</h6>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="fullName">Full Name</label>
                                                <input type="text" class="form-control" id="fullName" name="fullName"
                                                    placeholder="Enter full name">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="email">Email</label>
                                                <input type="email" class="form-control" id="email" name="email"
                                                    placeholder="Enter email ID">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="phoneNumber">Phone</label>
                                                <input type="text" class="form-control" id="phoneNumber"
                                                    name="phoneNumber" placeholder="Enter phone number">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="address">Address</label>
                                                <input type="text" class="form-control" id="address" name="address"
                                                    placeholder="Enter address">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group d-none">
                                                <label for="website">Password</label>
                                                <input type="password" class="form-control" id="password"
                                                    name="password" placeholder="Password">
                                                <i class="bi bi-eye-slash field-icon toggle-password"
                                                    id="toggle-Password"></i>
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="row form-group">
                                                <div class="col-6">
                                                    <label for="gender">Gender<span class="ml-2"
                                                            style="color: red;">*</span></label> <br>
                                                    <div class="form-check form-check-inline mt-2 mr-3">
                                                        <input class="form-check-input" type="radio" name="gender"
                                                            id="genderMale" value="1" checked>
                                                        <label class="form-check-label" for="genderMale">Nam</label>
                                                    </div>
                                                    <div class="form-check form-check-inline mt-2">
                                                        <input class="form-check-input" type="radio" name="gender"
                                                            id="genderFemale" value="0">
                                                        <label class="form-check-label" for="genderFemale">Nữ</label>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <label for="age">Age<span class="ml-2"
                                                            style="color: red;">*</span></label>
                                                    <input type="number" class="form-control" placeholder="Age" id="age"
                                                        name="age" style="width: 100%" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row gutters" id="tutor-info-detail">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 mb-3">
                                            <h6 class="mt-3 mb-2 text-primary">Tutor Details</h6>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="Street">Job</label>
                                                <input type="text" class="form-control" id="job" name="job"
                                                    placeholder="Enter Job">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="academicLevel">Academic Level</label>

                                                <select class="form-select form-control"
                                                    aria-label="Default select example" id="academicLevel"
                                                    name="academicLevel">
                                                    <option value="Sinh viên" selected>Sinh viên</option>
                                                    <option value="Giáo viên">Giáo viên</option>
                                                    <option value="12/12">12/12</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="subject">Subject</label>
                                                <input type="text" class="form-control" id="subject" name="subject"
                                                    placeholder="Enter subject">
                                            </div>
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                            <div class="form-group">
                                                <label for="addressTeach">Address Teach</label>
                                                <input type="text" class="form-control" id="addressTeach"
                                                    name="addressTeach" placeholder="Enter address to teach">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row gutters pt-3">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                            <div class="text-right">
                                                <!-- <button type="button" id="submit" name="submit"
                                                    class="btn btn-secondary mr-3">Cancel</button> -->
                                                <button type="submit" id="btnUpdate" name="btnUpdate"
                                                    class="btn btn-primary">Update</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

    </main>

    <!-- Button trigger modal update success-->
    <button id="update-success" type="button" class="btn btn-primary d-none" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
        Launch static backdrop modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title fs-5 pt-3" id="staticBackdropLabel" style="font-size: 18px;"><i
                        class="mr-2 bi bi-check-circle" style="color: green;"></i>Cập nhật thông tin thành công!</span>
                    <button type="button" class="btn" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x"
                            style="font-size: 24px;"></i></button>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Footer section-->
    <footer>
        <div id="footer-section" class="delivery-process-section pt-5"
            style="background-color: rgb(33, 35, 49); opacity: 0.9;color: white;">
            <div class="container">
                <div class="row position-relative p-1">
                    <div class="col-lg-3 col-md-6 col-sm-12 info-huetutor-footer">
                        <span class="info-huetutor-footer__title">
                            THÔNG TIN LIÊN HỆ
                        </span>
                        <ul>
                            <li><i class="mr-1 bi-geo-alt"></i>77 Nguyễn Huệ, Phú Nhuận, Thành phố Huế, Thừa Thiên Huế
                            </li>
                            <li><span class="mr-1  icon-envelope-open-o"></span> Huetutors@gmail.com</li>
                            <li><span class="mr-2  icon-phone"></span>(+84) 345476075</li>
                            <li><i class="mr-2 bi bi-shield-check"></i>Tiến Trần - HUSC</li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 info-huetutor-footer">
                        <span class="info-huetutor-footer__title ">
                            GIA SƯ CÁC MÔN
                        </span>
                        <ul>
                            <li><i class="mr-2 bi bi-check-lg"></i>Toán, tiếng việt</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Các môn THCS, THPT</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Các học phần ở Đại học, cao đẳng...</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Các loại chứng chỉ</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Ngoại ngữ</li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 info-huetutor-footer">
                        <span class="info-huetutor-footer__title ">
                            GIA SƯ CÁC LỚP
                        </span>
                        <ul>
                            <li><i class="mr-2 bi bi-check-lg"></i>Cấp tiểu học</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Cấp THCS, THPT</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Đại học, cao đẳng,...</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Lớp luyện thi chứng chỉ</li>
                            <li><i class="mr-2 bi bi-check-lg"></i>Lớp ngoại ngữ</li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 info-huetutor-footer">
                        <span class="info-huetutor-footer__title">
                            FANPAGE
                        </span>
                        <div class="fanpage-iframe pt-2 pb-2">
                            <div class="fb-page" data-href="https://www.facebook.com/trungtamgiasuhuegioi"
                                data-tabs="timeline" data-width="300" data-height="200" data-small-header="false"
                                data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true">
                                <blockquote cite="https://www.facebook.com/trungtamgiasuhuegioi"
                                    class="fb-xfbml-parse-ignore"><a
                                        href="https://www.facebook.com/trungtamgiasuhuegioi">Trung Tâm Gia Sư Tại Tp
                                        Huế</a></blockquote>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer-end-section" class="delivery-process-section"
            style="background-color:  rgb(43, 45, 59) ;color: white;">
            <div class="end-footer d-flex justify-content-center pt-3 pb-3" style="font-size: 14px;">
                © Copyright 2019 - 2023, Trung tâm gia sư Huế - HueTutors, All Rights Reserved.
            </div>
        </div>
    </footer>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/main.js"></script>
    <script src="js/login.js" type="module"></script>

    <!-- Use modal -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
        integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD"
        crossorigin="anonymous"></script>

    <script>

        //Show hide password
        function showHidePassword() {
            const togglePassword = document.querySelector("#toggle-Password");
            const password = document.querySelector("#password");

            togglePassword.addEventListener("click", function () {
                // toggle the type attribute
                const type = password.getAttribute("type") === "password" ? "text"
                    : "password";
                password.setAttribute("type", type);

                // toggle the icon
                this.classList.toggle("bi-eye");
            });
        }
        showHidePassword();

        //Change image
        function changeImage() {
            const fileInput = document.getElementById('file');
            const avatar = document.getElementById('avatar');

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();

                reader.readAsDataURL(file);

                reader.onload = () => {
                    avatar.src = reader.result;
                };
            });
        }

        //fetch api and render data
        const accessToken = localStorage.getItem('accessToken');
        const userInfo = fetch(`http://localhost:8080/api/v1/auth/getUserByAccessToken/${accessToken}`)
            .then(response => {
                return response.json();
            })
            .then(user => {
                const userId = user.data.userId;
                console.log(userId);
                //Nếu User đó có thông tin tutor thì lấy và hiển thị
                const roleInfo = fetch(`http://localhost:8080/api/v1/Tutors/getRole/${userId}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(info => {

                        /*Hiển thị ra giao diện*/
                        const imgEle = document.querySelector(".user-avatar");
                        imgEle.innerHTML = `<img id="avatar" src="http://localhost:8080/api/v1/Users/image/${info.data.user.userId}"
                                                alt="Maxwell Admin">`;
                        const usernameEle = document.querySelector(".user-name");
                        usernameEle.innerText = info.data.user.fullName;

                        const emailEle = document.querySelector(".user-email");
                        emailEle.innerText = info.data.user.email;

                        const likeEle = document.querySelector(".like-tutor");
                        likeEle.innerHTML = `Lượt like: ${info.data.likeNumber}`;

                        const fullNameInputValue = document.getElementById("fullName");
                        const emailInputValue = document.getElementById("email");
                        const phoneInputValue = document.getElementById("phoneNumber");
                        const addressInputValue = document.getElementById("address");
                        const passwordInputValue = document.getElementById("password");
                        const ageInputValue = document.getElementById("age");

                        fullNameInputValue.value = info.data.user.fullName;
                        emailInputValue.value = info.data.user.email;
                        phoneInputValue.value = info.data.user.phoneNumber;
                        addressInputValue.value = info.data.user.address;
                        passwordInputValue.value = info.data.user.password;
                        ageInputValue.value = info.data.user.age;

                        if (info.data.user.gender == 1) {
                            document.getElementById("genderMale").checked = true;
                        }
                        else {
                            document.getElementById("genderFemale").checked = true;
                        }

                        const tutorJobInputValue = document.getElementById("job");
                        const tutorALInputValue = document.getElementById("academicLevel");
                        const tutorSubjectValue = document.getElementById("subject");
                        const tutorAddressTeachInputValue = document.getElementById("addressTeach");

                        tutorJobInputValue.value = info.data.job;
                        tutorALInputValue.value = info.data.academicLevel
                        tutorSubjectValue.value = info.data.subject;
                        tutorAddressTeachInputValue.value = info.data.addressTeach;

                        changeImage();

                        //Update for User has Role = Tutor

                        const putUserTutorApi = `http://localhost:8080/api/v1/Tutors/updateUserAndTutor/${userId}/${info.data.tutorId}`;
                        const form = document.getElementById('update-form');
                                form.addEventListener('submit', async event => {
                                    event.preventDefault();

                                    const formData = new FormData(form);

                                    const response = await fetch(putUserTutorApi, {
                                        method: 'PUT',
                                        body: formData
                                    });
                                    if (!response.ok) {
                                        const message = `An error has accured: ${response.status}`;
                                        throw new Error(message);
                                        console.log(message);
                                        // registerFailedMessage.classList.remove('d-none');
                                    }
                                    const data = await response.json();
                                    console.log(data);
                                    //alert('update User successfully');

                                    const buttnOpenModal = document.getElementById("update-success");
                                    buttnOpenModal.click();

                                });

                    })
                    .catch(error => {
                        console.log(error);
                        //Nếu user đó k có thông tin của tutor thi chỉ hiện thông tin của user và không hiện lượt like
                        const roleInfoOnlyUser = fetch(`http://localhost:8080/api/v1/Users/${userId}`)
                            .then(response => response.json())
                            .then(info => {
                                const imgEle = document.querySelector(".user-avatar");
                                imgEle.innerHTML = `<img id="avatar" src="http://localhost:8080/api/v1/Users/image/${info.data.userId}"
                                                alt="Maxwell Admin">`;
                                const usernameEle = document.querySelector(".user-name");
                                usernameEle.innerText = info.data.fullName;

                                const emailEle = document.querySelector(".user-email");
                                emailEle.innerText = info.data.email;

                                const likeEle = document.querySelector(".like-tutor");
                                likeEle.innerText = "";

                                const fullNameInputValue = document.getElementById("fullName");
                                const emailInputValue = document.getElementById("email");
                                const phoneInputValue = document.getElementById("phoneNumber");
                                const addressInputValue = document.getElementById("address");
                                const passwordInputValue = document.getElementById("password");
                                const ageInputValue = document.getElementById("age");

                                fullNameInputValue.value = info.data.fullName;
                                emailInputValue.value = info.data.email;
                                phoneInputValue.value = info.data.phoneNumber;
                                addressInputValue.value = info.data.address;
                                passwordInputValue.value = info.data.password;
                                ageInputValue.value = info.data.age;

                                if (info.data.gender == 1) {
                                    document.getElementById("genderMale").checked = true;
                                }
                                else {
                                    document.getElementById("genderFemale").checked = true;
                                }
                                const tutorInfoDetail = document.getElementById("tutor-info-detail");
                                tutorInfoDetail.style.display = "none";

                                //Change image immediately
                                changeImage();

                                //Update User (Not is a tutor)
                                const putUserApi = `http://localhost:8080/api/v1/Users/${userId}`;
                                const form = document.getElementById('update-form');
                                form.addEventListener('submit', async event => {
                                    event.preventDefault();

                                    const formData = new FormData(form);
                                    formData.append("isAdmin", false);
                                    formData.delete("job");
                                    formData.delete("academicLevel");
                                    formData.delete("subject");
                                    formData.delete("addressTeach");

                                    const response = await fetch(putUserApi, {
                                        method: 'PUT',
                                        body: formData
                                    });
                                    if (!response.ok) {
                                        const message = `An error has accured: ${response.status}`;
                                        throw new Error(message);
                                        console.log(message);
                                        // registerFailedMessage.classList.remove('d-none');
                                    }
                                    const data = await response.json();
                                    console.log(data);
                                    //alert('update User successfully');

                                    const buttnOpenModal = document.getElementById("update-success");
                                    buttnOpenModal.click();

                                });

                            })
                            .catch(error => console.log(error));
                    });
            })
            .catch(error => {
                console.log(error);
                return "";
            });

       //Update Info (Role=user) by call API put Method
        // const form = document.getElementById('update-form');
        // form.addEventListener('submit', async event => {
        //     event.preventDefault();

        //     const formData = new FormData(form);
        //     formData.append("isAdmin", false);
        //     formData.delete("job");
        //     formData.delete("academicLevel");
        //     formData.delete("subject");
        //     formData.delete("addressTeach");

        //     const formDataObj = {};
        //     formData.forEach((value, key) => (formDataObj[key] = value));
        //     console.log(formDataObj);
        //     console.log(formDataObj.file);
        // });

        //Đang bị lỗi khi đăng xuất ra không về lại trang chủ (index.html) mà về lại trang userProfile mặc dù đã link tới file login.jss

    </script>
</body>

</html>